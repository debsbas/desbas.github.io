<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard — WAPED</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <div class="container">
      <div class="brand">WAPED Imobiliária</div>
      <nav>
        <a href="cadastro.html">Cadastrar</a>
        <a href="imoveis.html">Ver Imóveis</a>
        <a id="logout" href="#">Sair</a>
      </nav>
    </div>
  </header>

  <main class="container page-content">
    <h2>Dashboard do Corretor</h2>

    <div class="grid" style="margin-top:12px">
      <div class="card">
        <div class="card-body">
          <div class="title">Imóveis cadastrados</div>
          <div id="statTotal" class="price">0</div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="title">Fotos armazenadas</div>
          <div id="statFotos" class="price">0</div>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="title">Valor total (R$)</div>
          <div id="statValor" class="price">R$ 0</div>
        </div>
      </div>
    </div>

    <section style="margin-top:20px">
      <h3>Últimos Imóveis</h3>
      <div id="ultimos" class="grid"></div>
    </section>
  </main>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // proteção
    auth.onAuthStateChanged(user=>{
      if(!user) location.href='index.html';
    });

    document.getElementById('logout').addEventListener('click', async e=>{
      e.preventDefault();
      await signOut(auth);
      sessionStorage.removeItem('waped_user');
      location.href='index.html';
    });

    async function loadStats(){
      const snap = await getDocs(collection(db,'imoveis'));
      const items = snap.docs.map(d=>d.data());
      document.getElementById('statTotal').innerText = items.length;
      document.getElementById('statFotos').innerText = items.reduce((s,i)=>s+(i.fotos?.length||0),0);
      const total = items.reduce((s,i)=>s+(Number(i.valor)||0),0);
      document.getElementById('statValor').innerText = 'R$ ' + total.toLocaleString();

      const lastQ = query(collection(db,'imoveis'), orderBy('createdAt','desc'), limit(6));
      const lastSnap = await getDocs(lastQ);
      const last = lastSnap.docs.map(d=>d.data());
      document.getElementById('ultimos').innerHTML = last.map(i=>`
        <article class="card">
          <img src="${i.fotos?.[0]||'https://via.placeholder.com/520x320'}">
          <div class="card-body">
            <div class="title">${i.titulo}</div>
            <div class="meta">${i.cidade} • ${i.tipo}</div>
            <div class="price">R$ ${Number(i.valor).toLocaleString()}</div>
          </div>
        </article>
      `).join('');
    }

    loadStats();
  </script>
</body>
</html>
