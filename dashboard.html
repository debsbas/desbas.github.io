<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - WAPED Imobiliária</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="topbar">
    <div class="container">
      <div class="brand">WAPED Imobiliária</div>
      <nav>
        <a href="cadastro.html">Cadastrar</a>
        <a href="imoveis.html">Ver Imóveis</a>
        <a id="logout" href="#">Sair</a>
      </nav>
    </div>
  </header>

  <main class="container page-content">
    <h2>Dashboard</h2>
    <div class="grid-3">
      <div class="stat-card">
        <div class="stat-num" id="totalImoveis">0</div>
        <div class="stat-label">Imóveis Cadastrados</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="totalFotos">0</div>
        <div class="stat-label">Fotos Cadastradas</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="totalValor">R$ 0</div>
        <div class="stat-label">Valor Total dos Imóveis</div>
      </div>
    </div>

    <section style="margin-top:20px">
      <h3>Últimos Imóveis</h3>
      <div id="ultimosImoveis" class="grid-list"></div>
    </section>
  </main>

  <script type="module">
    import { auth, db } from './firebase.js';
    import { collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // Proteção de acesso
    auth.onAuthStateChanged(user => { if(!user) location.href='index.html'; });

    document.getElementById('logout').addEventListener('click', async e=>{
      e.preventDefault();
      await signOut(auth);
      location.href='index.html';
    });

    async function loadDashboard(){
      const snapshot = await getDocs(collection(db,'imoveis'));
      const items = [];
      snapshot.forEach(doc=>items.push(doc.data()));

      document.getElementById('totalImoveis').innerText = items.length;
      document.getElementById('totalFotos').innerText = items.reduce((acc,i)=>acc+(i.fotos?.length||0),0);
      document.getElementById('totalValor').innerText = 'R$ '+items.reduce((acc,i)=>acc+i.valor,0).toLocaleString();

      const ultimos = items.sort((a,b)=>b.createdAt?.seconds - a.createdAt?.seconds).slice(0,5);
      const cont = document.getElementById('ultimosImoveis');
      cont.innerHTML = ultimos.map(i=>`<article class="card item-card">
        <div class="item-head"><div class="item-code">${i.id}</div><div><strong>${i.titulo}</strong><div class="muted">${i.cidade} • ${i.tipo}</div></div></div>
        <div class="item-body">
          <div class="price">R$ ${Number(i.valor).toLocaleString()}</div>
          <div class="meta">Banheiros ${i.banheiros} • Garagem ${i.garagem}</div>
          ${i.fotos && i.fotos.length?`<img src="${i.fotos[0]}" style="width:100%;border-radius:6px;margin-top:8px">`:''}
        </div>
      </article>`).join('');
    }

    loadDashboard();
  </script>
</body>
</html>
